{const e=Promise.resolve();Gamma.textfield=s=>{const i=({target:t})=>(256&t._field._f||(t._field._f|=256,e.then(t._field.recalc)),t.remove(),r=null),h=t=>{const s=t.target,i=s._field;if(38==t.keyCode||40==t.keyCode){if(i._f>>1&1^t.shiftKey)38==t.keyCode?i.upArrowCb?.():i.downArrowCb?.();else if(2048&i._f)if(i.sel0==i.sel1){let e=i.sel0,s=e,h=i.sel0pos,l=h;for(;l;)e-=i.lines[--l].length;const n=i.lines[h].slice(0,e).width;if(38==t.keyCode&&h){const t=i.lines[h-1];i.sel0=i.sel1=s-e-t.length+t.indexAt(n)}else 40==t.keyCode&&h<i.lines.length-1&&(i.sel0=i.sel1=s-e+i.lines[h].length+i.lines[h+1].indexAt(n))}else 38==t.keyCode?i.sel0=i.sel1:i.sel1=i.sel0}else if(13==t.keyCode){if(!(i._f>>2&1^t.shiftKey))return;i.enterCb?.()}else{if(9!=t.keyCode)return;if(i._f>>3&1^t.shiftKey)i.tabCb?.();else if(1&i._f){const t=s.selectionStart;s.value=s.value.slice(0,t)+"\t"+s.value.slice(s.selectionEnd),s.selectionStart=s.selectionEnd=t+1,256&i._f||(i._f|=256,e.then(i.recalc))}}t.preventDefault()},l=(t,e)=>{const s=document.createElement(t);return s.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:absolute;inset:-100px;font-size:1px;font-family:monospace;white-space:nowrap",s.onblur=i,s.onkeydown=h,s.tabIndex=-1,s._field=e,document.documentElement.append(s),s},n=s.vec4;let r=null,c=0;const f=(t,e)=>t.insertLinePass(-1,0,1,e.focus?n(0,.2,.4,.6):n(.2,.2,.2,.6)),o=(t,e)=>{t.shader=null,(s.t-c)%1<.5&&t.drawRect(0,e.ascend-1,.05,1,n.one)};s.blinkTimer=()=>s.t-c;class a{_f=0;#t=0;#e=0;get allowTabs(){return 0!=(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return 0!=(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return 0!=(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return 0!=(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#s;constructor(t){this.#s=l(t?"textarea":"input",this),this._f=t}get value(){return this.#s.value}set value(t){this.#s.value=t,256&this._f||(this._f|=256,e.then(this.recalc))}get sel0(){return this.#t}set sel0(t){this.#s.selectionStart=this.#t=t,256&this._f||(this._f|=256,e.then(this.recalc))}get sel1(){return this.#e}set sel1(t){this.#s.selectionEnd=this.#e=t,256&this._f||(this._f|=256,e.then(this.recalc))}#i=null;get transformer(){return this.#i}set transformer(t){this.#i!=(this.#i=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}simpleTransformer(t,i="",...h){let l=h.slice();l[0]=h[0]?.times(.4)??n(.4),this.#i=e=>{const n=s.RichText(t);return h.length&&n.setValues(0,...h),e?n.add(e):(n.setValues(0,...l),n.drawOnly(),n.add(i)),n},256&this._f||(this._f|=256,e.then(this.recalc))}#h=o;#l=f;#n=null;#r=null;#c=1/0;#f=0;#o=0;#a=0;get sel0pos(){return this.#f}get sel1pos(){return this.#o}get multiline(){return 0!=(2048&this._f)}set multiline(t=!0){const s=this.#s,i=s.value,h=document.activeElement==s;if(t){if(2048&this._f)return;this.#n=null,this._f|=2304,this.#s=l("textarea",this)}else{if(!(2048&this._f))return;this.#r=null,this._f=-2049&this._f|256,this.#s=l("input",this)}h?this.focus=!0:(s.remove(),r==s&&(r=null),256&this._f||(this._f|=256,e.then(this.recalc))),this.#s.value=i,this.#s.selectionStart=this.#t,this.#s.selectionEnd=this.#e}get width(){return this.#a}get line(){return this.#n}get lines(){return this.#r}get cursor(){return this.#h}set cursor(t){this.#h!=(this.#h=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}get selector(){return this.#l}set selector(t){this.#l!=(this.#l=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}get maxWidth(){return this.#c}set maxWidth(t){this.#c=t,256&this._f||(this._f|=256,e.then(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const e=this.#s,i=this.#t,h=this.#e;this._f=-257&t,c=s.t;const l=e.value,n=this.#i?.(l,this)??s.RichText();if(i==h){const e=n.slice(i);n.trim(i),2048&t||(this.#f=this.#o=n.width),this.#h&&document.activeElement==this.#s&&n.addCb(this.#h),n.concat(e)}else{const e=n.slice(i),s=e.slice(h-i);e.trim(h-i),n.trim(i),2048&t?(this.#l?.(e,this),n.concat(e)):(this.#f=n.width,this.#l?.(e,this),n.concat(e),this.#o=n.width),n.concat(s)}if(2048&t){const t=this.#r=n.break(this.#c);let e=0;for(const{width:s}of t)s>e&&(e=s);this.#a=e;let s=i,l=0;for(;l<t.length&&s>=0;)s-=t[l++].length;for(s=h-i+s+(l?t[--l].length:0),this.#f=l;l<t.length&&s>=0;)s-=t[l++].length;this.#o=l?l-1:0}else this.#n=n,this.#a=n.width};insert(t="",s=t.length){const i=this.#s,h=i.value,l=i.selectionStart,n=i.selectionEnd;i.value=h.slice(0,l)+t+h.slice(n),i.selectionStart=i.selectionEnd=l+s,256&this._f||(this._f|=256,e.then(this.recalc))}get focus(){return document.activeElement==this.#s}set focus(t=!0){if(t){if(r){if(r==this.#s)return;r.replaceWith(r=this.#s)}else document.documentElement.append(r=this.#s);r.focus(),c=s.t}else r==this.#s&&(r.remove(),r=null)}get isSelecting(){return 0!=(this._f>>9&3)}lineHeight=1.3;lineAscend=.9;#u=0;get height(){return this.lineHeight*(this.#r?this.#r.length:1)}consumeInputs(i,{x:h,y:l}=i.from(s.cursor),n=s.keys.has(0)){if(l=this.lineAscend-l,cursorType="text",!n)return void(this._f=-1537&this._f);if(!this.focus&&(this.focus=!0,this.#t!=this.#e))return void(this._f|=1536);const r=this._f>>9&3;let c=0;if(this.#n)c=this.#n.indexAt(h);else if(this.#r){let t=floor(l/this.lineHeight);for(t=t<0?0:t>=this.#r.length?this.#r.length-1:t,c=this.#r[t].indexAt(h);t;)c+=this.#r[--t].length}if(1==r)c>this.sel1?(this.sel0=this.sel1,this.sel1=c,this._f=-1537&this._f|1024):c!=this.#t&&(this.#t=this.#s.selectionStart=c,256&this._f||(this._f|=256,e.then(this.recalc)));else if(2==r)c<=this.sel0?(this.sel1=this.sel0,this.sel0=c,this._f=-1537&this._f|512):c!=this.#e&&(this.#e=this.#s.selectionEnd=c,256&this._f||(this._f|=256,e.then(this.recalc)));else if(!r){let s=0,i=c,h=c;if(this.#u<0?this.#u-(this.#u=-t)<.3?s=2:this.#u=t:this.#u>0?this.#u-(this.#u=t)>-.3&&(s=1,this.#u=-t):this.#u=t,this._f=-1537&this._f|512,s){this._f|=1024;const t=this.#s.value,e=33-s;for(;t.codePointAt(h++)>e;);for(;t.codePointAt(--i)>e;);i++,h--}i==this.#t&&h==this.#e||(this.#s.selectionStart=this.#t=i,this.#s.selectionEnd=this.#e=h,256&this._f||(this._f|=256,e.then(this.recalc)))}}get height(){return this.#r?this.#r.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t){if(this.#r)for(const e of this.#r)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#n?.draw(t)}static#d=(document.addEventListener("input",(t=>{const s=t.target._field;s&&(s.#t=t.target.selectionStart,s.#e=t.target.selectionEnd,256&s._f||(s._f|=256,e.then(s.recalc)))})),document.addEventListener("selectionchange",(t=>{const s=t.target._field;s&&(s.#t=t.target.selectionStart,s.#e=t.target.selectionEnd,256&s._f||(s._f|=256,e.then(s.recalc)))})))}s.TextField=(t=!1)=>new a(t<<11&2048)}}