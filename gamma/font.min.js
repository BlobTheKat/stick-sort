Gamma.font=t=>{const e=t.vec4.one,s=t.Shader.MSDF=t.Shader("\nvoid main(){\n\tvec3 c = arg0().rgb;\n\tfloat sd = (uni0 < 0. ? c.r : max(min(c.r, c.g), min(max(c.r, c.g), c.b)))-.5+arg3*abs(uni0);\n\tfloat o = clamp(arg1*sd+.5,0.,1.);\n\tcolor = arg2*o;\n}",[t.COLOR,t.FLOAT,t.VEC4,t.FLOAT],[void 0,1,e,0],[t.FLOAT]);s.oldfv=0;const n=t.BreakToken=(t,e=0,s="",n)=>{if(t instanceof RegExp){let e=t.flags,s=e.indexOf("g");s>-1&&(e=e.slice(0,s)+e.slice(s+1)),e.includes("y")||(e+="y"),t=new RegExp(t.source,e)}else{let e="[";for(const s of t+""){const t=s.codePointAt();e+=t>=92&&t<=94||45==t?"\\"+s:s}t=new RegExp(e+"]","y")}return t.type=e,t.sep=s,t.next=n,t.sepW=t.sepA=t.sepS=0,t.sepL=null,t};n.NORMAL=0,n.NEVER_SPLIT=1,n.ALWAYS_SPLIT=2,n.OVERFLOW=3,n.VANISH=4,n.TRIM=5,n.SQUISH=6,n.SQUISH_SPLIT=7,n.BREAK_AFTER=8,n.BREAK_BEFORE=16,n.INVISIBLE=32;const o=[n(/\r\n?|\n/y,40,""),n(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,0,"-"),n(/\s+/y,4)],c=n(/[^]/y),r=new Map,h={0:null,1:0},l=[0,0,0,h],a=-2,f=(t,e,s,n=0)=>{if(t.sepL=e,t.sepA=s,t.sepS=n,!e)return t.sepW=0;let i=0;const{map:o,kmap:c}=e,r=1/s;for(const e of t.sep){const t=e.codePointAt(),h=o.get(t);if(!h)continue;const l=h.xadv+n+(c.get(t+-1114112)??0);i+=s&&asin(l*s)*r||l}return e.then?.((()=>t.sepL==e&&(t.sepL=null,t.sepW=0))),t.sepW=i};class u extends Array{#t=null;#e=s;#s=1;#n=0;#i=1;#o=0;#c=0;#r=0;#h=l;#l=0;#a=NaN;#f=null;#u=-1;static#p=class n{constructor(t){this.#b=t}sub(){const t=new n(this.#b);return t.#g=this.#g,t.#y=this.#y,t.#_=this.#_,t.#k=this.#k,t.#m=this.#m,t.#d=this.#d,t.#v=this.#v,t.#w=this.#w,t}reset(t=null){this.#g="object"==typeof t?t:null,this.#y=s,this.#_=1,this.#k=0,this.#m=0,this.#d=0,this.#w=null,this.#v=0,this.#b.#f==this&&(this.#b.#f=null)}#b;#g=null;get font(){return this.#g}set font(t){"object"==typeof t&&(this.#g=t),this.#b.#f==this&&(this.#b.#f=null)}#y=s;get shader(){return this.#y}set shader(t){"function"==typeof t&&(this.#y=t),this.#b.#f==this&&(this.#b.#f=null)}#_=1;get scale(){return this.#_}set scale(t){this.#_=+t,this.#b.#f==this&&(this.#b.#f=null)}scaleBy(t=1,e=!0,s=!0){if(1==t)return;const n=this.#b,i=n.length;let o=0,c=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,3==i||4==i&&s?(c||(c=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||c||(c=2)}1!=c&&n.unshift(3,t),n.#s*=t,s&&(n.#n*=t),n.#a=NaN,n.#f=null}#A=0;get yOffset(){return this.#A}set yOffset(t){this.#A=+t,this.#b.#f==this&&(this.#b.#f=null)}offsetBy(t=0){if(!t)return;const e=this.#b,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,4==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(4,t),e.#n+=t,e.#f=null}#k=1;get stretch(){return this.#k}set stretch(t){this.#k=+t,this.#b.#f==this&&(this.#b.#f=null)}stretchBy(t=1,e=!0,s=!1){if(1==t)return;const n=this.#b,i=n.length;let o=0,c=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,5==i||6==i&&s?(c||(c=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||c||(c=2)}1!=c&&(s?n.unshift(6,t,5,t):n.unshift(5,t)),n.#i*=t,s&&(n.#o*=t),n.#a=NaN,n.#f=null}get letterWidth(){return this.#_*this.stretch}set letterWidth(t){this.stretch=t/this.#_}#m=0;get skew(){return this.#m}set skew(t){this.#m=+t,this.#b.#f==this&&(this.#b.#f=null)}skewBy(t=0){if(!t)return;const e=this.#b,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,6==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(6,t),e.#o+=t,e.#f=null}#d=0;get letterSpacing(){return this.#d}set letterSpacing(t){this.#d=+t,this.#b.#f==this&&(this.#b.#f=null)}spaceBy(t=0){if(!t)return;const e=this.#b,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,7==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(7,t),e.#c+=t,e.#a=NaN,e.#f=null}#v=0;get curve(){return this.#v}set curve(t){this.#v=+t,this.#b.#f==this&&(this.#b.#f=null)}curveBy(t=0){if(!t)return;const e=this.#b,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,8==s?(i||(i=1),e[n-1]+=t):1!=s||i||(i=2)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(8,t),e.#r+=t,e.#a=NaN,e.#f=null}#w=l;addTextPass(t,e,s,...n){const i=n.length?{0:null,1:0}:h;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#w,c=this.#w=[];let r=0;for(;r<o.length;r+=4){if(!(o[r]<t)){o[r]==t&&(r+=4);break}c.push(o[r],o[r+1],o[r+2],o[r+3])}for(c.push(t,+e,+s,i);r<o.length;)c.push(o[r],o[r+1],o[r+2],o[r+3]),r+=4;this.#b.#f=null}addLinePass(t,e,s,...n){const i=n.length?{0:null,1:0}:h;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#w,c=this.#w=[];let r=0;for(;r<o.length;r+=4){if(!(o[r]<t)){o[r]==t&&(r+=4);break}c.push(o[r],o[r+1],o[r+2],o[r+3])}for(c.push(t,i,+e,+s);r<o.length;)c.push(o[r],o[r+1],o[r+2],o[r+3]),r+=4;this.#b.#f=null}setValues(t,...e){const s=this.#w=this.#w.slice();for(let n=0;n<s.length;n+=4){if(s[n]==t){let t=s[n+=3];"number"==typeof t&&(t=s[n-=2]),s[n]=t=t?Object.assign({},t):{0:null,1:0};for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}if(s[n]>t)break}this.#b.#f=null}delPass(t){const e=this.#w,s=this.#w=[];for(let n=0;n<e.length;n+=4){if(!(e[n]<t)){e[n]==t&&(n+=4);break}s.push(e[n],e[n+1],e[n+2],e[n+3])}for(;i<e.length;)s.push(e[i],e[i+1],e[i+2],e[i+3]),i+=4;this.#b.#f=null}insertTextPass(t,e,s,...n){const i=n.length?{0:null,1:0}:h;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#b,c=o.length;let r=0,l=0;for(;r<c;){let n=o[r++];if("number"==typeof n&&n>0)r++;else if("string"==typeof n||"function"==typeof n)l||(l=2);else if(Array.isArray(n)){l||(l=1);const c=o[r-1]=[];let h=0;for(;h<n.length;h+=4){if(!(n[h]<t)){n[h]==t&&(h+=4);break}c.push(n[h],n[h+1],n[h+2],n[h+3])}for(c.push(t,+e,+s,i);h<n.length;)c.push(n[h],n[h+1],n[h+2],n[h+3]),h+=4}}1!=l&&o.unshift(t>0?[0,0,0,h,t,e,s,i]:t<0?[t,e,s,i,0,0,0,h]:[t,e,s,i]),o.#f=null}insertLinePass(t,e,s,...n){const i=n.length?{0:null,1:0}:h;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#b,c=o.length;let r=0,l=0;for(;r<c;){let n=o[r++];if("number"==typeof n&&n>0)r++;else if("string"==typeof n||"function"==typeof n)l||(l=2);else if(Array.isArray(n)){l||(l=1);const c=o[r-1]=[];let h=0;for(;h<n.length;h+=4){if(!(n[h]<t)){n[h]==t&&(h+=4);break}c.push(n[h],n[h+1],n[h+2],n[h+3])}for(c.push(t,i,e,s);h<n.length;)c.push(n[h],n[h+1],n[h+2],n[h+3]),h+=4}}1!=l&&o.unshift(t>0?[0,0,0,h,t,i,e,s]:t<0?[t,i,e,s,0,0,0,h]:[t,i,e,s]),o.#f=null}adjustValues(t,...e){const s=this.#b,n=s.length;let i=0,o=0;for(;i<n;){const n=s[i++];if("number"==typeof n&&n>0)i++;else if("string"==typeof n||"function"==typeof n)o||(o=2);else if(Array.isArray(n)){const o=s[i-1]=n.slice();n==s.#h&&(s.#h=o);let c=0;for(;c<o.length;c+=4)if(o[c]==t){let t=o[c+=3];"number"==typeof t&&(t=o[c-=2]),o[c]=t=t?Object.assign({},t):{0:null,1:0};for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}}}s.#f=null}removePass(t){const e=this.#b,s=e.length;let n=0;t:for(;n<s;){let s=e[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let e=0;for(;e<s.length;e+=4){if(s[e]>t)continue t;if(s[e]==t){for(e+=4;e<s.length;)s[e-4]=s[e],s[e-3]=s[e+1],s[e-2]=s[e+2],s[e-1]=s[e+3],e+=4;s.length-=4;break}}}}}get values(){return this.#w}set values(t){this.#w=t?.length?t:null,this.#b.#f==this&&(this.#b.#f=null)}drawOnly(){this.#b.push(this.#b.#u=-3)}indexOnly(){this.#b.push(this.#b.#u=a)}drawAndIndex(){this.#b.push(this.#b.#u=-1)}advance(t=0){const e=this.#b;e.l!=this&&this.#q(e),e.push(1,+t),e.w=NaN}#q(t){this.#g!=t.#t&&t.push(t.#t=this.#g),this.#y!=t.#e&&t.push(2,t.#e=this.#y),this.#_!=t.#s&&t.push(3,t.#s=this.#_),this.#A!=t.#n&&t.push(4,t.#n=this.#A),this.#k!=t.#i&&t.push(5,t.#i=this.#k),this.#m!=t.#o&&t.push(6,t.#o=this.#m),this.#d!=t.#c&&t.push(7,t.#c=this.#d),this.#v!=t.#r&&t.push(8,t.#r=this.#v),this.#w!=t.#h&&(t.push(this.#w),t.#h=this.#w),t.#f=this}copy(){const t=this.#b,e=t.slice(),s=e.#f=this.sub();return s.#b=e,e.#t=t.#t,e.#e=t.#e,e.#s=t.#s,e.#n=t.#n,e.#i=t.#i,e.#o=t.#o,e.#c=t.#c,e.#r=t.#r,e.#h=t.#h,e.#u=t.#u,e.#l=t.#l,e.#a=t.#a,s}slice(t=0,e=1/0){const s=this.#b,i=new u;t<0&&(t+=s.#l)<0&&(t=0),e<0&&(e+=s.#l)<0&&(e=0);const o=new n(i);let c=0;if(e<=0){for(;c<s.length;){const t=s[c++];if("number"==typeof t){if(t<0){i.#u=t;continue}const e=s[c++];switch(t){case 1:c-=2;break;case 2:o.#y=e;break;case 3:o.#_=e;break;case 4:o.#A=e;break;case 5:o.#k=e;break;case 6:o.#m=e;break;case 7:o.#d=e;break;case 8:o.#v=e}}else{if("string"==typeof t||"function"==typeof t)break;Array.isArray(t)?o.#w=t:o.#g=t}}return-1!=i.#u&&i.push(i.#u),o.#q(i),o}e=e>=t?e-t:0;let r="";for(;t>0&&c<s.length;){const n=s[c++];if("number"==typeof n){if(n<0){i.#u=n;continue}const t=s[c++];switch(n){case 2:o.#y=t;break;case 3:o.#_=t;break;case 4:o.#A=t;break;case 5:o.#k=t;break;case 6:o.#m=t;break;case 7:o.#d=t;break;case 8:o.#v=t}}else if("string"==typeof n){if(!(2&i.#u))continue;if((t-=n.length)<0){r=n.slice(t,(e+=t)+n.length);break}}else Array.isArray(n)?o.#w=n:"object"==typeof n&&(o.#g=n)}for(o.#q(i),-1!=i.#u&&i.push(i.#u),r&&(i.push(r),i.#l+=r.length);e>0&&c<s.length;){const t=s[c++];if(i.push(t),"number"==typeof t){if(t<0){i.#u=t;continue}const e=s[c++];switch(i.push(e),t){case 2:o.#y=e;break;case 3:o.#_=e;break;case 4:o.#A=e;break;case 5:o.#k=e;break;case 6:o.#m=e;break;case 7:o.#d=e;break;case 8:o.#v=e}}else if("string"==typeof t){if(!(2&i.#u))continue;e-=t.length,i.#l+=t.length,e<0?(i[i.length-1]=t.slice(0,e),i.#l+=t.length+e):i.#l+=t.length}else Array.isArray(t)?o.#w=t:"object"==typeof t&&(o.#g=t)}return o}trim(t=1/0){const e=this.#b;if(t<0&&(t+=e.#l)<0&&(t=0),t>e.#l)return;let n=0;if(e.#t=null,e.#e=s,e.#s=1,e.#i=1,e.#n=0,e.#o=0,e.#c=0,e.#u=-1,e.#r=0,e.#h=l,e.#l=t<0?0:t)for(;t>0&&n<e.length;){const s=e[n++];if("number"==typeof s){if(s<0){e.#u=s;continue}const t=e[n++];switch(s){case 2:e.#e=t;break;case 3:e.#s=t;break;case 4:e.#n=t;break;case 5:e.#i=t;break;case 6:e.#o=t;break;case 7:e.#c=t;break;case 8:e.#r=t}}else if("string"==typeof s){if(!(2&e.#u))continue;if((t-=s.length)<0){e[n-1]=s.slice(0,t);break}}else Array.isArray(s)?e.#h=s:"object"==typeof s&&(e.#t=s)}else for(;n<e.length;){const t=e[n++];if("number"==typeof t){if(t<0){e.#u=t;continue}const s=e[n++];switch(t){case 1:n-=2;break;case 2:e.#e=s;break;case 3:e.#s=s;break;case 4:e.#n=s;break;case 5:e.#i=s;break;case 6:e.#o=s;break;case 7:e.#c=s;break;case 8:e.#r=s}}else{if("string"==typeof t||"function"==typeof t){n--;break}Array.isArray(t)?e.#h=t:e.#t=t}}this.#g=e.#t,this.#y=e.#e,this.#_=e.#s,this.#A=e.#n,this.#k=e.#i,this.#m=e.#o,this.#d=e.#c,this.#v=e.#r,this.#w=e.#h,e.length=n,e.#a=NaN}concat(t){const e=this.#b,n=t.#b;e.#l+=n.#l;let i=0;this.#g=null,this.#y=s,this.#_=1,this.#A=0,this.#k=1,this.#m=0,this.#d=0,this.#v=0,this.#w=l;const o=n.length;let c=-1;t:for(;i<o;){const t=n[i++];if("number"==typeof t){if(t<0){c=t;continue}const e=n[i++];switch(t){case 1:i-=2;break t;case 2:this.#y=e;break;case 3:this.#_=e;break;case 4:this.#A=e;break;case 5:this.#k=e;break;case 6:this.#m=e;break;case 7:this.#d=e;break;case 8:this.#v=e}}else{if("string"==typeof t||"function"==typeof t){i--;break}Array.isArray(t)?this.#w=t:this.#g=t}}for(this.#q(e),c!=e.#u&&e.push(e.#u=c);i<o;){const t=n[i++];if(e.push(t),"number"==typeof t){if(t<0){e.#u=t;continue}const s=n[i++];switch(e.push(s),t){case 2:this.#y=s;break;case 3:this.#_=s;break;case 4:this.#A=s;break;case 5:this.#k=s;break;case 6:this.#m=s;break;case 7:this.#d=s;break;case 8:this.#v=s}}else"string"==typeof t?2&e.#u&&(e.#l+=t.length):Array.isArray(t)?this.#w=t:"object"==typeof t&&(this.#g=t)}e.#a=NaN}get length(){return this.#b.#l}set length(t){this.trim(t)}get width(){const t=this.#b;let e=t.#a;if(e==e)return e;e=0;let s=r,n=r,i=0,o=1,c=1,h=0,l=-1,a=0,f=0,u=1,p=-1,b=1;for(;i<t.length;){let g=t[i++];if("number"==typeof g){if(g<0){l=g;continue}const s=t[i++];switch(g){case 1:e+=u*s,p=-1;break;case 3:u=(o=s)*c;break;case 5:u=(c=s)*o;break;case 7:h=s;break;case 8:f=1/s,a=s}}else if("string"==typeof g){if(1&l)for(const t of g){const i=t.codePointAt(),o=s.get(i);if(!o)continue;const c=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const r=(o.xadv+h)*u+c;e+=a&&asin(r*a)*f||r,o.tex?.waiting&&o.tex.load()}}else if("object"==typeof g){if(!g){s=n=r;continue}if(Array.isArray(g))continue;s=g.map,n=g.kmap,g.then?.((()=>t.#a=NaN))}}return t.#a=e}add(t){const e=this.#b;e.#f!=this&&this.#q(e),2&e.#u&&(e.#l+=(t+="").length),e.push(t),e.#a=NaN}addCb(t,e=NaN){if("function"!=typeof t)return;const s=this.#b;s.#f!=this&&this.#q(s),e==e?s.push(t,1,e):s.push(t)}indexAt(t=0){const e=this.#b;let s=r,n=r,i=0,o=1,c=1,h=0,l=-1,a=0,f=0,u=1,p=-1,b=1,g=0,y=0;for(;i<e.length;){let _=e[i++];if("number"==typeof _){if(_<0){l=_;continue}const s=e[i++];switch(_){case 1:t-=u*s,p=-1;break;case 3:u=(o=s)*c;break;case 5:u=(c=s)*o;break;case 7:h=s;break;case 8:f=1/s,a=s}}else if("string"==typeof _)if(1&l)for(const e of _){const i=e.codePointAt(),o=s.get(i);if(!o){2&l&&(y=g+=e.length);continue}const c=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const r=(o.xadv+h)*u+c,_=a&&asin(r*a)*f||r;if(t-=_,2&l){if(t<=-.5*_)return y;y=g+=e.length}}else 2&l&&(g+=_.length);else if("object"==typeof _){if(!_){s=n=r;continue}if(Array.isArray(_))continue;s=_.map,n=_.kmap}}return y}draw(t){const n=this.#b;let i=r,o=r,c=0,h=1,a=1,f=1,u=0,p=0,b=0,g=0,y=0,_=-1,k=t.shader=s,m=l,d=3,v=null,w=0;m[3][1]=1;let A=-1,q=1;const x=t.pixelRatio();let N=1,R=0;t:for(;c<n.length;){let s=n[c++];if("number"==typeof s){if(s<0){_=s;continue t}const e=n[c++];switch(s){case 1:if(y){p&&t.skew(-p,0);const s=.5/y,n=e*y*2;t.rotate(R),t.translate(sin(n)*s,(1-cos(n))*s),t.rotate(-n),R=0,p&&t.skew(p,0)}else t.translate(e,0);A=-1;continue t;case 3:const n=e*a;a=1/e,t.scale(n),b*=h*=a,g*=h,q*=n,y*=n,h=e,v&&(N=x*v.normDistRange*h);for(let t=0;t<d;t+=4)("object"==typeof e[t+3]?e[t+3]:e[t+1])[1]=N;continue t;case 4:b=e*a,g=b*p;continue t;case 2:t.shader=k=s;break;case 5:f=e;continue t;case 6:t.skew(e-p,0),p=e,g=b*e;continue t;case 7:u=.5*e;continue t;case 8:y=e*h;continue t;default:continue t}}else{if("string"==typeof s){if(1&_)for(const n of s){const s=n.codePointAt(),c=i.get(s);if(!c)continue;const r=(o.get(s+1114112*A)??0)*min(q,f);A=s,q=f;const h=(c.xadv+u+u)*f+r,l=r-g;y&&(p&&t.skew(-p,0),t.rotate(R+(R=-asin(h*y)||0)),p&&t.skew(p,0));for(let s=0;s<d;s+=4){const n=m[s+1],i=m[s+2]+b,o=m[s+3];if("object"==typeof n){const s=y*h*(i+w);n[0]=e,t.drawRectv(l+s,i+w,h-s-s,o,n)}else c.tex&&(o[0]=c.tex,t.drawRectv((c.x+u)*f+n+l,c.y+i,c.w*f,c.h,o))}t.translate(h,0)}continue}if("function"==typeof s){const e=t.sub();p&&e.skew(-p,0),R&&e.rotate(R),s(e,v)}else{if(!s){i=o=r;continue}if(Array.isArray(s)){d=(m=s).length;for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=N;continue}v=s,w=v.ascend-1,i=s.map,o=s.kmap,N=x*v.normDistRange*h;for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=N}}if(v){const t=(1&v._flags?.5:-.5)/v.normDistRange;t!=k.oldfv&&k.uniforms(k.oldfv=t)}}p&&t.skew(-p,0),R&&t.rotate(R),1!=h&&t.scale(a)}break(t=1/0,e=o,s={scale:1,letterSpacing:0,curve:0}){const i=this.#b;let h=1,l="",p=0;for(;p<i.length;){const t=i[p++];"number"==typeof t&&(t<0?h=1&t:p++),"string"==typeof t&&h&&(l+=t)}const b=[];let g="number"==typeof t?t:"function"==typeof t?t(b.length,s):t[min(b.length,t.length-1)],y=new u,_=y.l=new n(y),k=0,m="";p=0;let d=r,v=r,w=1,A=1,q=-1,x=0,N=!1;for(;p<l.length;){let o,h=0,R=y.length,S=x,L=_.#y,O=_.#_,P=_.#A,j=_.#k,B=_.#m,F=_.#d,T=_.#g,I=_.#v,E=_.#w,W=y.#u,M=y.#l;t:{if(e)for(o of e){o.lastIndex=p;const t=o.exec(l);if(t){p+=h=t[0].length,e=o.next??e;break t}}p+=h=1,o=c}const D=o.type;16&D&&(b.push(_),y.#a=N?NaN:x,N=!1,_=_.sub(),_.#b=y=new u,g="number"==typeof t?t:"function"==typeof t?t(b.length,s):t[min(b.length,t.length-1)],R=S=x=M=0,-1!=W&&y.push(y.#u=W),_.#q(y));const H=32&D&&y.#u!=a;if(m){let t=m;h<m.length?(t=m.slice(0,h),m=m.slice(h),h=0):(h-=m.length,m=""),H&&y.push(a),t&&y.push(t),2&y.#u&&(y.#l+=t.length),H&&y.push(y.#u)}for(;h>0;){const t=i[k++];if("number"==typeof t){if(t<0){y.#u=t,y.push(t);continue}const e=i[k++];switch(y.push(t,e),t){case 2:_.#y=y.#e=e;break;case 3:_.#_=y.#s=e;break;case 4:_.#A=y.#n=e;break;case 5:_.#k=y.#i=e;break;case 6:_.#m=y.#o=e;break;case 7:_.#d=y.#c=e;break;case 8:_.#v=y.#r=e}}else if("string"==typeof t){if(!(1&y.#u)){y.push(t),y.#l+=t.length;continue}h-=t.length;let e=t;h<0?(e=t.slice(0,h),m=t.slice(h)):m="",H&&y.push(a),y.push(e),2&y.#u&&(y.#l+=e.length),H&&y.push(y.#u)}else y.push(t),Array.isArray(t)?y.#h=_.#w=t:"function"!=typeof t&&(y.#t=_.#g=t)}for(;;){let e=R,i=0,c=0,h=L,l=O,p=P,k=j,m=B,H=F,V=T,C=E,G=W,U=M,z=I,K=1/z,Q=!1,Y=o.sepL==V&&o.sepA==z&&o.sepS==H?o.sepW:f(o,V,z,H);const $=D?0!=(36>>D&1):2*S<g,{scale:J=1,letterSpacing:X=0,curve:Z=0}=s;N||=1!=J||0!=X||0!=Z;let tt=z+Z,et=H+X;for(Z&&(K=1/tt);e<y.length;){const t=y[e++];if("number"==typeof t){if(t<0){G=t;continue}const s=y[e++];switch(t){case 1:if(x+=s,q=-1,x>g-(Y-(v.get(o.sep.codePointAt()+1114112*q)??0))*w||!$)break;R=e-2,c=0,Q=!0,S=x,L=h,O=l,P=p,j=k,B=m,F=H,T=V,I=z,E=C,W=G,M=U;break;case 2:h=s;break;case 3:l=s,w=s*k*J;break;case 4:p=s;break;case 5:k=s,w=s*l*J;break;case 6:m=s;break;case 7:H=s,et=s+X;break;case 8:tt=s+Z,K=1/tt,z=s}}else if("string"==typeof t)if(i=0,1&G)for(const s of t){const t=s.codePointAt(),n=d.get(t);if(i+=s.length,2&G&&(U+=s.length),!n)continue;const r=(v.get(t+1114112*q)??0)*min(w,A);A=w,q=t;const a=(n.xadv+et)*w+r;x+=tt&&asin(a*tt)*K||a,x<=g-(Y-(v.get(o.sep.codePointAt()+1114112*t)??0))*w&&$&&(Q=!0,R=e-1,c=i,S=x,L=h,O=l,P=p,j=k,B=m,F=H,T=V,I=z,E=C,W=G,M=U)}else 2&G&&(U+=t.length);else if(Array.isArray(t))C=t;else{if("function"==typeof t)continue;(V=t)?(d=t.map,v=t.kmap,Y=o.sepL==t&&o.sepA==z&&o.sepS==H?o.sepW:f(o,t,z,H)):(d=v=r,Y=0)}}if(!S||x<=g||!R||3==D)break;if(e=R,i=c,h=L,l=O,p=P,k=j,m=B,H=F,V=T,C=E,G=W,z=I,U=M,6==D||7==D&&g-S>=x-g){const t=(g-S)/(x-S),s=y.length;for(y.splice(e,0,5,t*k),e+=2;e<s;){const s=y[e++];"number"!=typeof s||s<0||(5==s?y[e++]*=t:e++)}y.push(5,k);break}x=S;const st=new u,nt=new n(st),it=y.length;nt.#y=h,nt.#_=l,nt.#A=p,nt.#k=k,nt.#m=m,nt.#d=H,nt.#g=V,nt.#w=C,nt.#v=z,st.#u=G;let ot=e+=!!i;const ct=4!=D&&5!=D;if(i){nt.#q(st);const t=y[e-1];y[e-1]=t.slice(0,i),st.push(t.slice(i))}else{t:for(;ot<it;){const t=y[ot++];if("number"==typeof t){if(t<0){st.#u=t;continue}const e=y[ot++];switch(t){case 1:if(ct){ot-=2;break t}break;case 2:nt.#y=e;break;case 3:nt.#_=e;break;case 4:nt.#A=e;break;case 5:nt.#k=e;break;case 6:nt.#m=e;break;case 7:nt.#d=e;break;case 8:nt.#v=e}}else{if("string"==typeof t||"function"==typeof t){ot--;break}Array.isArray(t)?nt.#w=t:nt.#g=t}}nt.#q(st)}if(ct)for(-1!=st.#u&&st.push(st.#u);ot<it;)st.push(y[ot++]);else for(st.push(a);ot<it;){const t=y[ot++];"number"!=typeof t?st.push(t):t>0&&st.push(t,y[ot++])}st.#l=y.#l-U,y.#l=U,y.#a=N?NaN:x,N=!1,nt.#y=st.#e=_.#y,nt.#_=st.#s=_.#_,nt.#A=st.#n=_.#A,nt.#k=st.#i=_.#k,nt.#m=st.#o=_.#m,nt.#d=st.#c=_.#d,nt.#v=st.#r=_.#v,st.#u=y.#u,nt.#w=st.#h=_.#w,y.length=e,ct||st.#u==a||st.push(st.#u),Q&&(-3!=y.#u&&y.push(y.#u=-3),y.push(o.sep)),b.push(_),_=nt,y=st,g="number"==typeof t?t:"function"==typeof t?t(b.length,s):t[min(b.length,t.length-1)],R=c=S=x=M=0}if(8&D){b.push(_),y.#a=N?NaN:x,N=!1;const e=y.#u;x=0,_=_.sub(),_.#b=y=new u,g="number"==typeof t?t:"function"==typeof t?t(b.length,s):t[min(b.length,t.length-1)],-1!=e&&y.push(y.#u=e),_.#q(y)}}for(;k<i.length;){const t=i[k++];if(y.push(t),"number"==typeof t){if(t<0){y.#u=t;continue}const e=i[k++];switch(y.push(e),t){case 2:_.#y=y.#e=e;break;case 3:_.#_=y.#s=e;break;case 4:_.#A=y.#n=e;break;case 5:_.#k=y.#i=e;break;case 6:_.#m=y.#o=e;break;case 7:_.#d=y.#c=e;break;case 8:_.#v=y.#r=e}}else Array.isArray(t)?y.#h=_.#w=t:"object"==typeof t&&(y.#t=_.#g=t)}return y.#a=N?NaN:x,b.push(_),b}toString(){let t="",e=!0,s=0;const n=this.#b,i=n.length;for(;s<i;){const i=n[s++];"number"==typeof i&&(i<0?e=!!(2&i):s++),"string"==typeof i&&e&&(t+=i)}return t}static#p=t.RichText=(t=null)=>{const e=new u;if(!t)return e.#f=new n(e);const s=new n(e);return s.#g=t,s}}}class p{_flags=0;normDistRange=0;#x=[];map=new Map;ascend=0;kmap=new Map;get then(){return this.#x?this.#N:void 0}#N(t,e){this.#x?.push(t,e)}get isMsdf(){return!!(1&this._flags)}set isMsdf(t){this._flags=-2&this._flags|t}done(){const t=this.#x;if(this.#x=null,t)for(let e=0;e<t.length;e+=2)t[e]?.(this)}error(t){const e=this.#x;if(this.#x=null,e)for(let s=1;s<e.length;s+=2)e[s]?.(t)}chlumsky(t,e){return fetch(t).then((e=>(t=e.url,e.json()))).then((t=>{const{atlas:{type:s,distanceRange:n,size:i,width:o,height:c},metrics:{ascender:r,descender:h},glyphs:l,kerning:a}=t,f=(this.isMsdf=s.toLowerCase().endsWith("msdf"))?Formats.RGB:Formats.R,u=Img(e,SMOOTH,f);this.normDistRange=n/i*2,this.ascend=r/(r-h);for(const{unicode1:t,unicode2:e,advance:s}of a)this.kmap.set(e+1114112*t,s);for(const{unicode:t,advance:e,planeBounds:s,atlasBounds:n}of l)this.map.set(t,s?{x:s.left,y:s.bottom,w:s.right-s.left,h:s.top-s.bottom,xadv:e,tex:u.sub(n.left/o,n.bottom/c,(n.right-n.left)/o,(n.top-n.bottom)/c)}:{x:0,y:0,w:0,h:0,xadv:e,tex:null});this.done()}),this.error.bind(this)),this}bmfont(t,e=0){return fetch(t).then((e=>(t=e.url,e.json()))).then((s=>{const{chars:n,distanceField:i,pages:o,info:{size:c},common:{base:r,lineHeight:h,scaleW:l,scaleH:a},kernings:f}=s,u=(this.isMsdf=i.fieldType.toLowerCase().endsWith("msdf"))?Formats.RGB:Formats.R;this.normDistRange=i.distanceRange/h*2;const p=this.ascend=r/h,b=o.map((e=>Img(new URL(e,t).href,SMOOTH,u)));for(const{first:t,second:e,amount:s}of f)this.kmap.set(e+1114112*t,s/c);for(const{id:t,x:s,y:i,width:o,height:r,xoffset:h,yoffset:f,xadvance:u,page:g}of n)this.map.set(t,{x:h/c,y:p-(f-e+r)/c,w:o/c,h:r/c,xadv:u/c,tex:o&&r?b[g].sub(s/l,1-(i+r)/a,o/l,r/a):null});this.done()}),this.error.bind(this)),this}draw(t,e,n=-1,i=0,...o){if(this.#x)return;i*=.5;let c=t.pixelRatio()*this.normDistRange,r=t.shader;void 0===r.oldfv&&(r=t.shader=s);const h=(1&this._flags?.5:-.5)/this.normDistRange;h!=r.oldfv&&r.uniforms(r.oldfv=h);const{map:l,kmap:a}=this;for(const s of e){const e=s.codePointAt(),r=l.get(e);if(!r)continue;const h=a.get(e+1114112*n)??0;n=e;const f=r.xadv+i+i+h;r.tex&&t.drawRect(r.x+i+h,r.y,r.w,r.h,r.tex,c,...o),t.translate(f,0)}return n}measure(t,e=-1,s=0){if(this.#x)return;let n=0;const{map:i,kmap:o}=this;for(const c of t){const t=c.codePointAt(),r=i.get(t);if(!r)continue;const h=o.get(t+1114112*e)??0;e=t,n+=r.xadv+s+h}return n}}t.Font=()=>new p,t.Font.bmfont=(t,e)=>(new p).bmfont(t,e),t.Font.chlumsky=(t,e)=>(new p).chlumsky(t,e)};